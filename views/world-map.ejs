<!DOCTYPE html>
<html lang="en">
    <head>
       <title>World</title>
       <meta charset="UTF-8">
       <link rel="stylesheet" href="/static/css/world.css">
    </head>

    <body>
        <div id="world-container">
        </div>

        <div class="side-panel">
            <button class="close-button">X</button>

            <div class="side-panel-container">
                <h1 style="text-align: center;">Country</h1>

                <div class="recipes-container">
                </div>

                <h2 class="no-recipes-yet">No recipes yet.</h2>
            </div>
        </div>

        <script>
          const COUNTRIES_JSON_URL = "/static/countries.json";
          const SVG_MAP_URL = "/static/img/world.svg";
          const SVG_DOWNSCALE_FACTOR = 1.25;

          const sidePanel = document.querySelector(".side-panel");
          const noRecipesMessage = document.querySelector(".no-recipes-yet");

          const closePanelButton = document.querySelector(".close-button");
          closePanelButton.addEventListener("click", () => {
              sidePanel.style.right = "-30em";
          });

          fetch(COUNTRIES_JSON_URL)
               .then(response => response.json())
               .then(countryAbbreviationNames => {

                   const getCountryNameAbbreviations = (countryAbbreviationNames) => {
                       const countryNameAbbreviations = {};
                       for (const abbreviation in countryAbbreviationNames) {
                           let name = countryAbbreviationNames[abbreviation];

                           if (name in countryNameAbbreviations) {
                               console.warn(`Could not replace existing abbreviation with '${abbreviation}'. ${name} is already abbreviated as '${countryNameAbbreviations[name]}'.`);
                           }
                           else {
                               countryNameAbbreviations[name] = abbreviation;
                           }
                       }
                       return countryNameAbbreviations;
                   }
                   const countryNameAbbreviations = getCountryNameAbbreviations(countryAbbreviationNames);

                   fetch(SVG_MAP_URL)
                        .then(response => response.text())
                        .then(svgMapText => {
                            // TODO: Stop using innerHTML to incorporate svg
                            const worldContainer = document.querySelector("div#world-container");
                            worldContainer.innerHTML = svgMapText;
    
                            const svgMap = document.querySelector("svg");
    
                            svgMap.removeAttribute("fill");
                            svgMap.removeAttribute("stroke");
                            svgMap.removeAttribute("stroke-width");
    
                            const initialWidth = svgMap.getAttribute("width");
                            const initialHeight = svgMap.getAttribute("height");
    
                            svgMap.setAttribute("width", initialWidth / SVG_DOWNSCALE_FACTOR);
                            svgMap.setAttribute("height", initialHeight / SVG_DOWNSCALE_FACTOR);
    
                            svgMap.addEventListener("click", (event) => {
                                const targetElement = event.target;
                                if (targetElement.nodeName === "path") {
                                    const header = document.querySelector("h1");
                                    let abbreviation;
                                    let countryName;
                                    if (targetElement.classList.length) {
                                        const classArray = Array.from(targetElement.classList);
                                        countryName = classArray.join(" ");

                                        abbreviation = countryNameAbbreviations[countryName];
                                    }
    
                                    else if (targetElement.id) {
                                        const attributes = targetElement.attributes;
                                        const nameAttribute = attributes.name;
                                        countryName = nameAttribute.nodeValue;

                                        abbreviation = countryNameAbbreviations[countryName];
                                    }
                                    header.textContent = `${countryName} (${abbreviation})`;

                                    const recipesContainer = document.querySelector("div.recipes-container");
                                    recipesContainer.innerHTML = "";

                                    fetch(`/world?tag=${abbreviation.toLowerCase()}&country=${encodeURIComponent(countryName.toLowerCase())}`)
                                        .then(response => response.json())
                                        .then(recipes => {

                                            noRecipesMessage.textContent = "";
                                            noRecipesMessage.style.display = "none";

                                            for (const recipe of recipes) {
                                                const recipeDiv = document.createElement("div");
                                                recipeDiv.className = "recipe";
                                                const recipeTitle = document.createElement("h2");
                                                const recipeImage = document.createElement("img");

                                                recipeImage.className = "thumbnail"
                                                recipeImage.src = `/static/uploads/multimedia/${recipe.thumbnail}`


                                                recipeDiv.addEventListener("click", () => {
                                                    window.location.href = `${window.location.origin}/static/recipe-view.html?id=${recipe.id}`;
                                                });

                                                recipeTitle.textContent = recipe.name;

                                                recipeDiv.appendChild(recipeImage);
                                                recipeDiv.appendChild(recipeTitle);
                                                recipesContainer.appendChild(recipeDiv);
                                            }

                                            if (!recipes.length) {
                                                noRecipesMessage.textContent = "No recipes yet.";
                                                noRecipesMessage.style.display = "flex";
                                            }

                                            sidePanel.style.right = "0em";
                                        })
                                        .then(error => console.error(error));



                                }
                            });
    
                        }).catch(error => console.error("Error fetching SVG: " + error));
    
                  }).catch(error => console.error("Error fetching CSV: " + error));

       </script>
    </body>
</html>
