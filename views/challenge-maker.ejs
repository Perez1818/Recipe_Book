<!DOCTYPE html>

<html lang="en">
    <head>
        <title>Challenge Maker</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="/static/css/styles.css">
        <link rel="stylesheet" href="/static/css/challenge-maker.css">
        <link rel="stylesheet" href="/static/css/styles.css">
        <link rel="stylesheet" href="/static/css/challenge-maker.css">
        <style>
            div.field {
                margin: 10px;
            }
            
            p {
                margin: 0;
            }

            p.success {
                color: green;
            }

            p.error {
                color: red;
            }

            label {
                font-weight: bold;
                display: block;
            }
            div.ingredients {
                margin-left: 0px;
            }

            div.title {
                display: flex;
                justify-content: center;
                align-items: center;
            }
        </style>
    </head>

    <body>
        <header>
            <p id="logo"> Recipe Book</p>
            <!-- Navbar with emphasis on "home" icon -->
            <nav>
                <a href="/static/account.html" class="tooltip">
                    <span class="tooltiptext">Account</span>
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="30px" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    </svg>
                </a>
                <a href="/static/index.html" class="tooltip">
                    <svg class="icon-highlight icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                    </svg>
                    <span class="tooltiptext">Home</span>
                </a>
                <a href="/static/search-engine.html" class="tooltip">
                    <span class="tooltiptext">Search</span>
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m15.75 15.75-2.489-2.489m0 0a3.375 3.375 0 1 0-4.773-4.773 3.375 3.375 0 0 0 4.774 4.774ZM21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                </a>
                <a href="/static/calendar.html" class="tooltip">
                    <span class="tooltiptext">Calendar</span>
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="size-6">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
                    </svg>
                </a>
                <a href="/static/shopping-list.html" class="tooltip">
                    <span class="tooltiptext">Shopping List</span>
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                    </svg>
                </a>
                <a href="/static/challenges.html" class="tooltip">
                    <span class="tooltiptext">Bulletin Board</span>
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" />
                    </svg>
                </a>
                <a href="/static/create-recipe.html" class="tooltip">
                    <span class="tooltiptext">Recipe Maker</span>
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                    </svg>
                </a>
            </nav>
        </header>
        <hr width="100%">
        <main>
            <h1>Challenge Maker</h1>
            <form id="form-body" action="" method="post" enctype="multipart/form-data">
                <div id="inner-container">
                    <div class="field">
                        <label for="thumbnail">Thumbnail: </label>
                        <input type="file" id="file" name="thumbnail">
                    </div>

                    <div class="field">
                        <label for="title">Title: </label>
                        <input type="text" id="title" name="title" value="">
                    </div>

                    <div class="field">
                        <label for="description">Description: </label>
                        <textarea id="description" name="description"></textarea>
                    </div>

                    <div class="field">
                        <label for="start">Start: </label>
                        <input type="date" id="start" name="start" value="">
                    </div>

                    <div class="field">
                        <label for="cutoff">End: </label>
                        <input type="date" id="cutoff" name="cutoff" value="">
                    </div>

                    <div class="field">
                        <label for="points">Points: </label>
                        <input type="number" id="points" name="points">
                    </div>

                    <div class="field">
                        <label for="max-ingredients">Max Ingredients: </label>
                        <input type="number" id="max-ingredients" name="max-ingredients">
                    </div>

                    <div class="field">
                        <label for="required-ingredients">Required Ingredients: </label>


                        <div class="ingredients">
                            <button type="button" id="add-ingredient">+ Ingredient</button>
                        </div>
                    </div>

                    <input id="submit-button" type="submit" value="Create">
                </div>
                <div id="preview-holder">
                    <img id="preview">
                </div>
            </form>
        </main>
        <script>
            const formContainer = document.querySelector("#inner-container");

            const addIngredientButton = document.querySelector("button#add-ingredient");
            addIngredientButton.addEventListener("click", () => {
                const ingredients = document.querySelector("div.ingredients");

                const ingredient = document.createElement("div");
                ingredient.className = "ingredient";

                const ingredientInput = document.createElement("input");
                ingredientInput.type = "text";
                ingredientInput.name = "required-ingredients[]";
                ingredientInput.value = "";

                const removeIngredientButton = document.createElement("button");
                removeIngredientButton.type = "button";
                removeIngredientButton.id = "remove-ingredient";
                removeIngredientButton.textContent = "X";
                removeIngredientButton.addEventListener("click", (event) => {
                    const removeIngredientButton = event.target;
                    const ingredient = removeIngredientButton.parentNode;
                    if (ingredient) {
                        ingredient.remove();
                    }
                });

                ingredient.appendChild(ingredientInput);
                ingredient.appendChild(removeIngredientButton);
                ingredients.appendChild(ingredient);
            });

            addIngredientButton.click();

            const pointsElement = document.getElementById("points");

            // Load in preview after uploading thumbnail
            const fileInput = document.getElementById("file");
            const preview = document.getElementsByTagName("img")[0];
            fileInput.addEventListener("change", () => {
                const file = fileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                    preview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    preview.style.backgroundColor = "transparent";
                } else {
                    preview.style.display = "none";
                }
            });

            const pointsElement = document.getElementById("points");

            // Load in preview after uploading thumbnail
            const fileInput = document.getElementById("file");
            const preview = document.getElementsByTagName("img")[0];
            fileInput.addEventListener("change", () => {
                const file = fileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                    preview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    preview.style.backgroundColor = "transparent";
                } else {
                    preview.style.display = "none";
                }
            });

            const form = document.querySelector("form");
            form.addEventListener("submit", (event) => {
                event.preventDefault();

                // clear success and error messages
                const paragraphs = Array.from(document.querySelectorAll("p"));
                for (const paragraph of paragraphs) {
                    paragraph.remove();
                }

                const formData = new FormData(form);

                fetch(form.action, { method: form.method, body: formData })
                .then(response => {
                    // https://stackoverflow.com/questions/50041257/how-can-i-pass-json-body-of-fetch-response-to-throw-error-with-then
                    return response.json()
                           .then(json => {
                               if (response.ok) {
                                   return Promise.resolve(json);
                               }
                               return Promise.reject(json);
                           });
                })
                .then(data => {
                    let paragraph = document.createElement("p");
                    paragraph.className = "success";
                    paragraph.textContent = data.message;
                    paragraph.style.marginLeft = "10px";
                    formContainer.prepend(paragraph);
                }).catch(data => {
                    const errorMessages = data.errorMessages;
                    if (errorMessages) {
                        for (const attribute in errorMessages) {
                            let message = errorMessages[attribute];
                            if (message !== undefined) {
                                let label = document.querySelector(`label[for="${attribute}"]`);
                                if (label) {
                                    let field = label.parentNode;

                                    let paragraph = document.createElement("p");
                                    paragraph.className = "error";
                                    paragraph.textContent = message;

                                    field.appendChild(paragraph);
                                }
                            }
                        }
                    }
                    else {
                        let paragraph = document.createElement("p");
                        paragraph.className = "error";
                        paragraph.textContent = data.message;
                        paragraph.style.marginLeft = "10px";
                        formContainer.prepend(paragraph);
                    }
                })
            });
        </script>
        <script type="module">
            // Load in avatar
            import { getCurrentUserDetails } from "/static/js/users.js";

            const profile = document.getElementsByClassName("icon")[0];
            const accountLink = document.getElementsByClassName("tooltip")[0];
            const current_user = await getCurrentUserDetails();

            function loadLoggedUserAvatar(current_user) {
                const profilePic = current_user.avatar;
                const img = document.createElement("img");
                img.style.width = "45px";
                img.style.height = "45px";
                img.style.borderRadius = "50%";            
                img.src = profilePic;
                accountLink.href = `/user/${current_user.username}`;
                
                if (current_user.avatar) {
                    profile.replaceWith(img);
                }
            }

            // Load in avatar if user is signed in and add path to their profile
            if (current_user) {
                loadLoggedUserAvatar(current_user);
            } else {
                accountLink.style.cursor = "not-allowed";
                accountLink.href = "#";
            }
    </script>
    </body>
</html>

