<!DOCTYPE html>

<html lang="en">
    <head>
        <title>Challenge Maker</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="/static/css/styles.css">
        <link rel="stylesheet" href="/static/css/challenge-maker.css">
        <style>
            div.field {
                margin: 10px;
            }
            
            p {
                margin: 0;
            }

            p.success {
                color: green;
            }

            p.error {
                color: red;
            }

            label {
                font-weight: bold;
                display: block;
            }
            div.ingredients {
                margin-left: 0px;
            }

            div.title {
                display: flex;
                justify-content: center;
                align-items: center;
            }
        </style>

    </head>

    <body>
        <div class="title">
            <h1>Challenge Maker</h1>
        </div>
        <form id="form-body" action="" method="post" enctype="multipart/form-data">
            <div id="inner-container">
                <div class="field">
                    <label for="file">Thumbnail</label>
                    <input type="file" id="file" name="thumbnail">
                </div>

                <div class="field">
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title" value="">
                </div>

                <div class="field">
                    <label for="description">Description</label>
                    <textarea id="description" name="description"></textarea>
                </div>

                <div class="field">
                    <label for="start">Start</label>
                    <input type="date" id="start" name="start" value="">
                </div>

                <div class="field">
                    <label for="cutoff">End</label>
                    <input type="date" id="cutoff" name="cutoff" value="">
                </div>

                <div class="field">
                    <label for="points">Points</label>
                    <input type="number" id="points" name="points">
                </div>

                <div class="field">
                    <label for="max-ingredients">Max Ingredients</label>
                    <input type="number" id="max-ingredients" name="max-ingredients">
                </div>

                <div class="field">
                    <label for="required-ingredients">Required Ingredients</label>


                    <div class="ingredients">
                        <button type="button" id="add-ingredient">+ Ingredient</button>
                    </div>
                </div>

                <input id="submit-button" type="submit" value="Create">
            </div>
            <div id="preview-holder">
                <img id="preview">
            </div>
        </form>

        <script>
            const addIngredientButton = document.querySelector("button#add-ingredient");
            addIngredientButton.addEventListener("click", () => {
                const ingredients = document.querySelector("div.ingredients");

                const ingredient = document.createElement("div");
                ingredient.className = "ingredient";

                const ingredientInput = document.createElement("input");
                ingredientInput.type = "text";
                ingredientInput.name = "required-ingredients[]";
                ingredientInput.value = "";

                const removeIngredientButton = document.createElement("button");
                removeIngredientButton.type = "button";
                removeIngredientButton.id = "remove-ingredient";
                removeIngredientButton.textContent = "X";
                removeIngredientButton.addEventListener("click", (event) => {
                    const removeIngredientButton = event.target;
                    const ingredient = removeIngredientButton.parentNode;
                    if (ingredient) {
                        ingredient.remove();
                    }
                });

                ingredient.appendChild(ingredientInput);
                ingredient.appendChild(removeIngredientButton);
                ingredients.appendChild(ingredient);
            });

            addIngredientButton.click();

            const pointsElement = document.getElementById("points");

            // Load in preview after uploading thumbnail
            const fileInput = document.getElementById("file");
            const preview = document.getElementsByTagName("img")[0];
            fileInput.addEventListener("change", () => {
                const file = fileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                    preview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    preview.style.backgroundColor = "transparent";
                } else {
                    preview.style.display = "none";
                }
            });

            const form = document.querySelector("form");
            form.addEventListener("submit", (event) => {
                event.preventDefault();

                // clear success and error messages
                const paragraphs = Array.from(document.querySelectorAll("p"));
                for (const paragraph of paragraphs) {
                    paragraph.remove();
                }

                const formData = new FormData(form);

                fetch(form.action, { method: form.method, body: formData })
                .then(response => {
                    // https://stackoverflow.com/questions/50041257/how-can-i-pass-json-body-of-fetch-response-to-throw-error-with-then
                    return response.json()
                           .then(json => {
                               if (response.ok) {
                                   return Promise.resolve(json);
                               }
                               return Promise.reject(json);
                           });
                })
                .then(data => {
                    let paragraph = document.createElement("p");
                    paragraph.className = "success";
                    paragraph.textContent = data.message;
                    form.prepend(paragraph);
                }).catch(data => {
                    const errorMessages = data.errorMessages;
                    if (errorMessages) {
                        for (const attribute in errorMessages) {
                            let message = errorMessages[attribute];
                            if (message !== undefined) {
                                let label = document.querySelector(`label[for="${attribute}"]`);
                                if (label) {
                                    let field = label.parentNode;

                                    let paragraph = document.createElement("p");
                                    paragraph.className = "error";
                                    paragraph.textContent = message;

                                    field.appendChild(paragraph);
                                }
                            }
                        }
                    }
                    else {
                        let paragraph = document.createElement("p");
                        paragraph.className = "error";
                        paragraph.textContent = data.message;
                        form.prepend(paragraph);
                    }
                })
            });
        </script>
    </body>
</html>

